<div id="map">
</div>

<script>
	"use strict";
	//calling map and setting view to a static location
		var map = L.map('map', { center: [22, 122], maxBounds: [[90, -180], [-90, 180]] }).setView([10, 0.1], 1);

		L.tileLayer('http://{s}.tile.cloudmade.com/f644205df10c4e16a94c5c9b74438873/998/256/{z}/{x}/{y}.png', {
		    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
		    maxZoom: 18,
		    minZoom: 1   
		}).addTo(map);

	//TRACKS STUFF
	_.templateSettings = {
	  interpolate : /\{\{(.+?)\}\}/g
	};
	//calling tracks from the database and then displaying on map
	function ajaxTrackRequest() {
		$.ajax(
		'/get_database_tracks',
		{ success: function(lastTracks){
			var trackUrlConcatStrings = "";
			
			//iterate through called tracks and bind to map marker: 
			//popup track info and play track upon click
			_.each(lastTracks, function(lastTrack) {
				var coords = [];
				coords.push(lastTrack.lat)
				coords.push(lastTrack.lng)

				L.marker(coords)
					.addTo(map)
					.bindPopup("<div class='top'>" 
						+ "<img src='" + lastTrack.user_avatar_url
						+ "'width='80'>" + "<p class='name'>" 
						+ lastTrack.username  
						+ "</p></div>"  
						+ "<a href='http://soundcloud.com/" + lastTrack.user_permalink + "/" + lastTrack.track_permalink 
						+ "'target='_blank'>"
						+ "<em>" 
						+ lastTrack.track_name 
						+ "</em></a><br />" 
						+	lastTrack.user_city + ", " + lastTrack.user_country) 
					.on("click", function(event) {var trackId = lastTrack.track_id;
					onMarkerClick(trackId);
					})
					.on("click", function() { map.setView(coords, 3);
					})
				 // if i.zero? 
					// .openPopup();
				 // end
				var trackUrlString = "<a href='http://soundcloud.com/" + lastTrack.user_permalink + "/" + lastTrack.track_permalink + "'></a>"; 
				trackUrlConcatStrings += trackUrlString
			});
			
			var template = '<div class="sc-player">' + trackUrlConcatStrings + '</div>';
			var widgetContainer = document.getElementsByClassName("widget-container")[0]
			var currentTrack = _.template(template, 'null')
			widgetContainer.innerHTML+= currentTrack

			var scPlayerScript = document.createElement("script");
			scPlayerScript.setAttribute("src", "/sc-player.js");
			var body = document.getElementsByTagName("body")[0];
			body.appendChild(scPlayerScript);

			$(document).on('click','.get-more-tracks', function(event) {
			    var $list = $(this).closest('.footer').find('ol.sc-trackslist');
			    // simulate the click in the tracklist
			    $list.find('li.active').click();
			    return false;
			});

			$('.get-more-tracks').click(function(){
					$.ajax(
					'/get_database_tracks',
					{ success: function(lastTracks){
						var trackUrlConcatStrings = "";
						//iterate through called tracks and bind to map marker: 
						//popup track info and play track upon click
						_.each(lastTracks, function(lastTrack) {
							var coords = [];
							
							coords.push(lastTrack.lat)
							coords.push(lastTrack.lng)
							L.marker(coords)
								.addTo(map)
								.bindPopup("<div class='top'>" 
									+ "<img src='" + lastTrack.user_avatar_url
									+ "'width='80'>" + "<p class='name'>" 
									+ lastTrack.username  
									+ "</p></div>"  
									+ "<a href='http://soundcloud.com/" + lastTrack.user_permalink + "/" + lastTrack.track_permalink 
									+ "'target='_blank'>"
									+ "<em>" 
									+ lastTrack.track_name 
									+ "</em></a><br />" 
									+	lastTrack.user_city + ", " + lastTrack.user_country) 
								.on("click", function(event) {var trackId = lastTrack.track_id;
								onMarkerClick(trackId);
								})
								.on("click", function() { map.setView(coords, 3);
								})
							 // if i.zero? 
								// .openPopup();
							 // end
							var trackUrlString = "<a href='http://soundcloud.com/" + lastTrack.user_permalink + "/" + lastTrack.track_permalink + "'></a>"; 
							trackUrlConcatStrings += trackUrlString
						});
						
						var template = '<div class="sc-player">' + trackUrlConcatStrings + '</div>';
						var widgetContainer = document.getElementsByClassName("widget-container")[0]
						var currentTrack = _.template(template, 'null')
						widgetContainer.innerHTML = currentTrack

						var scPlayerScript = document.createElement("script");
						scPlayerScript.setAttribute("src", "/sc-player.js");
						var body = document.getElementsByTagName("body")[0];
						body.appendChild(scPlayerScript);
						}
					});
				});
			}
		});
	}
	
	//pulls up popup window on clicked marker and closes other popup windows. intended to switch song also.
	function onMarkerClick(trackId) {
		$(".track").hide();
		$("#track-" + trackId).show().find(".sc-trackslist a").click();
	};
	ajaxTrackRequest();
	</script>

<div class="footer">
	<header>
		<nav class="site_name">
			<h1>Global Grooves Project</h1>
			<h3>Locally Sourced Beats</h3>
		</nav>
	</header>
	<div class='widget-container'>
	</div>
	<div class='call-tracks'>
		<button class="get-more-tracks">ajax</button>
	</div>	
</div>
